# Баллистический калькулятор для QGroundControl

Баллистический калькулятор - это модуль QGroundControl для расчета точки приземления груза при сбросе с дрона с учетом ветра, высоты и аэродинамических характеристик.

## Основные возможности

- Расчет точки приземления с учетом:
  - Ветра (автоматическое определение по углам наклона дрона)
  - Высоты (фиксированная, барометрическая или управление с пульта)
  - Аэродинамических характеристик груза
- Визуализация точки падения на OSD
- Отображение траектории падения
- Профили для разных типов грузов
- Калибровка OSD для точного прицеливания
- Индикация готовности к сбросу

## Настройка

### Параметры груза

1. Откройте настройки QGC
2. Перейдите в раздел "Баллистический калькулятор"
3. Установите параметры груза:
   - Масса (в граммах)
   - Коэффициенты сопротивления (вертикальный и горизонтальный)
   - Площади сечения (вертикальная и горизонтальная)
   - Смещение от камеры (в сантиметрах)

### Режим определения высоты

Выберите один из трех режимов:
1. Фиксированная высота - указывается постоянная высота сброса
2. Барометрическая высота - используется текущая высота дрона
3. Управление с пульта - высота регулируется через AUX канал:
   - Выберите номер AUX канала
   - Установите минимальную и максимальную высоту

### Профили грузов

- Создание профиля:
  1. Нажмите кнопку "Профили" в правом верхнем углу OSD
  2. Введите имя нового профиля
  3. Нажмите "Сохранить"

- Управление профилями:
  - Переключение: выберите профиль из списка
  - Удаление: нажмите кнопку "Удалить" рядом с профилем
  - Быстрое сохранение: в режиме калибровки нажмите 'S'

### Калибровка OSD

1. Включите режим калибровки в настройках
2. Используйте клавиши:
   - Стрелки: перемещение прицельной метки
   - +/-: изменение размера метки
   - R: сброс калибровки
   - S: сохранение в текущий профиль

## Использование

1. Активируйте баллистический калькулятор кнопкой "B" на OSD
2. Выберите или создайте профиль груза
3. Проверьте калибровку прицельной метки
4. Следите за индикаторами:
   - Прицельная метка показывает расчетную точку падения
   - Желтая линия указывает направление ветра
   - Индикатор готовности показывает возможность сброса
   - Информационная панель отображает координаты точки падения, время падения и параметры ветра

## Определение ветра

Калькулятор автоматически определяет ветер по углам наклона дрона:
- Тангаж (pitch) определяет силу ветра спереди/сзади
- Крен (roll) определяет боковой ветер
- 1 градус наклона ≈ 1 м/с ветра

## Рекомендации

1. Перед использованием:
   - Проведите калибровку OSD
   - Создайте и сохраните профили для разных грузов
   - Проверьте работу в режиме симуляции

2. Во время полета:
   - Держите дрон максимально стабильно для точного определения ветра
   - Следите за индикатором готовности к сбросу
   - Учитывайте время падения при планировании сброса

3. Безопасность:
   - Всегда проверяйте зону сброса
   - Учитывайте запас высоты
   - Не превышайте максимально допустимую скорость ветра

## Устранение неполадок

1. Неточное определение точки падения:
   - Проверьте калибровку OSD
   - Убедитесь в правильности параметров груза
   - Проверьте стабильность удержания позиции дроном

2. Проблемы с определением ветра:
   - Проверьте калибровку гироскопов дрона
   - Убедитесь, что дрон стабильно удерживает позицию
   - Попробуйте включить фильтрацию данных ветра

3. Некорректное отображение маркера:
   - Проверьте настройки смещения камеры
   - Перекалибруйте положение маркера
   - Проверьте работу подвеса камеры

## Техническая документация

### Архитектура

Баллистический калькулятор состоит из следующих компонентов:

1. `BallisticCalculator` - основной класс, выполняющий расчеты:
   - Расчет траектории падения
   - Определение точки приземления
   - Обработка данных о ветре
   - Взаимодействие с Vehicle для получения телеметрии

2. `BallisticCalculatorSettings` - управление настройками:
   - Параметры груза
   - Калибровочные данные
   - Профили
   - Настройки отображения

3. `BallisticTargetIndicator.qml` - визуальный интерфейс:
   - Отображение прицельной метки
   - Калибровка OSD
   - Управление профилями
   - Визуализация траектории

### Формулы расчета

1. Определение ветра:
```
windX = -pitch * (180.0 / PI)  // м/с
windY = -roll * (180.0 / PI)   // м/с
windSpeed = sqrt(windX² + windY²)
windDirection = atan2(windY, windX) * 180.0 / PI
```

2. Расчет траектории:
```
// Сила сопротивления воздуха
Fd = 0.5 * ρ * Cd * A * v²

// Ускорения
ax = -Fd * vx / (m * v)
ay = -Fd * vy / (m * v)
az = -g - Fd * vz / (m * v)

// Интегрирование методом Эйлера
v = v + a * dt
x = x + v * dt
```

### Интеграция в QGC

1. Регистрация компонентов:
```cpp
// В SettingsManager
private:
    BallisticCalculatorSettings* _ballisticCalculatorSettings;

// В Vehicle
private:
    BallisticCalculator* _ballisticCalculator;
```

2. Подключение к OSD:
```qml
// В FlyViewCustomLayer.qml
BallisticTargetIndicator {
    anchors.fill: parent
    visible: QGroundControl.settingsManager.ballisticCalculatorSettings.isEnabled.rawValue
}
```

### Профили грузов

Профили хранятся в формате JSON:
```json
{
    "profileName": {
        "payloadMass": 100,
        "verticalDragCoefficient": 0.47,
        "horizontalDragCoefficient": 0.47,
        "verticalCrossSection": 10,
        "horizontalCrossSection": 10,
        "cameraOffset": 0,
        "markerSize": 32,
        "markerOffsetX": 0,
        "markerOffsetY": 0
    }
}
```

### Расширение функционала

1. Добавление новых параметров груза:
   - Добавить параметр в `BallisticCalculator.SettingsGroup.json`
   - Обновить `BallisticCalculatorSettings.h`
   - Добавить параметр в функции сохранения/загрузки профилей

2. Модификация расчетов:
   - Изменить метод `calculateTrajectoryPoints()` в `BallisticCalculator`
   - При необходимости обновить формулы определения ветра

3. Изменение визуализации:
   - Модифицировать `BallisticTargetIndicator.qml`
   - Добавить новые элементы управления в настройках

### Отладка

1. Логирование:
```cpp
qDebug() << "Wind:" << windSpeed << "m/s," << windDirection << "degrees";
qDebug() << "Target:" << targetPoint.latitude() << targetPoint.longitude();
```

2. Тестирование в SITL:
   - Запустить QGC с симулятором
   - Проверить расчеты при разных условиях
   - Сравнить результаты с теоретическими расчетами 

## Тестирование в SITL

### Подготовка окружения

1. Установка ArduPilot SITL:
```bash
git clone https://github.com/ArduPilot/ardupilot.git
cd ardupilot
Tools/environment_install/install-prereqs-ubuntu.sh
./waf configure --board sitl
./waf copter
```

2. Запуск симулятора:
```bash
cd ArduCopter
sim_vehicle.py -w --console --map
```

3. Запуск QGroundControl с отладочной информацией:
```bash
QGC_LOGGING=full ./QGroundControl
```

### Сценарии тестирования

1. Базовая функциональность:
   - Подключение к симулятору
   - Активация баллистического калькулятора
   - Проверка отображения OSD
   - Создание и переключение профилей

2. Тестирование определения ветра:
   - Установить ветер в симуляторе:
     ```
     param set SIM_WIND_SPD 5  # скорость ветра 5 м/с
     param set SIM_WIND_DIR 180  # направление ветра 180 градусов
     ```
   - Проверить углы наклона дрона
   - Сверить определенную скорость и направление ветра

3. Тестирование расчета траектории:
   - Взлететь на заданную высоту (например, 50м)
   - Проверить расчетную точку падения без ветра
   - Включить ветер и проверить смещение точки
   - Сравнить с теоретическими расчетами

4. Проверка режимов высоты:
   - Фиксированная высота:
     ```
     param set PLND_ENABLED 1
     param set PLND_TYPE 1
     ```
   - Барометрическая высота:
     ```
     param set BARO_ENABLE 1
     param set BARO_ALT_NOISE 0.1
     ```
   - Управление по AUX каналу:
     ```
     param set RC7_OPTION 7  # настройка AUX канала
     ```

5. Тестирование калибровки:
   - Включить режим калибровки
   - Проверить работу клавиш управления
   - Сохранить и загрузить калибровку в профиль

### Проверка точности

1. Теоретический расчет:
```python
import math

def calculate_impact_point(height, wind_speed, wind_direction):
    g = 9.81  # ускорение свободного падения
    t = math.sqrt(2 * height / g)  # время падения без сопротивления
    
    # Смещение из-за ветра
    dx = wind_speed * math.cos(wind_direction) * t
    dy = wind_speed * math.sin(wind_direction) * t
    
    return dx, dy, t

# Пример использования
height = 50  # метров
wind_speed = 5  # м/с
wind_direction = math.pi  # 180 градусов

dx, dy, t = calculate_impact_point(height, wind_speed, wind_direction)
print(f"Смещение: {dx:.2f}м, {dy:.2f}м")
print(f"Время падения: {t:.2f}с")
```

2. Сравнение результатов:
   - Запустить тест в симуляторе
   - Записать реальные значения
   - Сравнить с теоретическими
   - Допустимая погрешность: ±5%

### Проверка граничных условий

1. Предельные значения:
   - Минимальная/максимальная высота
   - Экстремальные значения ветра
   - Предельные параметры груза

2. Ошибочные ситуации:
   - Потеря сигнала GPS
   - Нестабильное удержание позиции
   - Отказ датчиков высоты

### Журнал тестирования

Для каждого теста записывать:
```
Дата: YYYY-MM-DD
Тест: [название теста]
Условия:
- Высота: X м
- Ветер: Y м/с, Z градусов
- Профиль груза: [название]

Результаты:
- Расчетная точка: lat, lon
- Время падения: T с
- Отклонение от теории: N%

Проблемы:
- [список обнаруженных проблем]

Статус: [PASS/FAIL]
```

### Отчет об ошибках

При обнаружении проблем указывать:
1. Шаги воспроизведения
2. Ожидаемое поведение
3. Фактическое поведение
4. Логи QGC и SITL
5. Скриншоты/видео (если применимо) 